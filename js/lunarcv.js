// Source code available at http://github.com/julienvo/lunarCV
(function(){function arraysEqual(a,b){if(a.length!==b.length)return!1;for(var c=a.length;c--;)if(a[c]!==b[c])return!1;return!0}var competences=["htmlcss","vanillajs","jquery","bootstrap","angular","mongo","nodejs","ajax","express","meteor"],cfgTerrain={width:3e3,nbPlateformes:competences.length,variance:800,amorti:1},gravite=.005,showMessage=function(a){document.querySelector("#message").innerHTML=a,document.querySelector("#messageContainer").style.display="block"},hideMessage=function(){document.querySelector("#messageContainer").style.display="none"},debug=!1,keyEvent={gauche:!1,droite:!1,haut:!1,bas:!1,entree:!1},timeStart,timeElapsed,compteurCompetences,compteurFrames,state="start",score=8e3;window.addEventListener("load",function(a){var c=(document.getElementById("message"),document.getElementById("canvas")),d=document.getElementById("infos");window.onkeydown=function(a){var b=a.keyCode;switch(lastKeys.shift(),lastKeys.push(b),arraysEqual(lastKeys,cheatCode)&&afficherIcones(),b){case 13:a.preventDefault(),keyEvent.entree=!0;break;case 32:a.preventDefault(),"crash"==state?(vaisseau.init(vaisseau.posX,terrain[Math.floor(mod(vaisseau.posX,cfgTerrain.width))]+150,!1),state="playing",hideMessage(),e()):("gameOver"==state&&f(),g());break;case 37:a.preventDefault(),keyEvent.gauche=!0;break;case 38:a.preventDefault(),keyEvent.haut=!0;break;case 39:a.preventDefault(),keyEvent.droite=!0;break;case 40:a.preventDefault(),keyEvent.bas=!0}},window.onkeyup=function(a){a.preventDefault();var b=a.keyCode;switch(b){case 13:keyEvent.entree=!1;break;case 37:keyEvent.gauche=!1;break;case 38:son.pause(),keyEvent.haut=!1;break;case 39:keyEvent.droite=!1;break;case 40:keyEvent.bas=!1}};var e=function(){if(compteurFrames++,compteurFrames%50==0&&(score-=50),10==compteurCompetences)showMessage("Vous avez gagné !!! <br /><br /> Vous pouvez désormais accéder à la version pdf de mon CV en cliquant sur le lien dans la navbar."),afficherIcones();else if(vaisseau.crash||"playing"!=state)boom.play(),vaisseau.fuel>0?(state="crash",showMessage("Vous vous êtes crashé. Appuyez sur espace pour reprendre depuis un endroit sûr.")):(state="gameOver",showMessage("Vous n'avez plus d'essence, Game Over :( <br/><br/>Appuyez sur espace pour recommencer."));else{if(updateVaisseau(),vaisseau.pose){if(vaisseau.currentPlatform.isActive){score+=Math.max(Math.round(2e3*(1-(vaisseau.lastVelX-vaisseau.lastVelY))),0),vaisseau.currentPlatform.isActive=!1;var a=document.querySelector("#"+competences[compteurCompetences]);a.className="",setTimeout(function(){a.style.opacity=1},100),compteurCompetences++}}else keyEvent.gauche&&(vaisseau.angle-=Math.PI/60),keyEvent.droite&&(vaisseau.angle+=Math.PI/60);keyEvent.haut&&vaisseau.fuel>0?(vaisseau.acc=.0125,son.play()):(vaisseau.acc=0,son.pause()),timeElapsed=Date.now()-timeStart,camera.update(),renderGame(c),renderInfos(d),requestAnimationFrame(e)}},f=function(){initializeTerrain(),generateTerrain(0,cfgTerrain.width-1,cfgTerrain.variance,cfgTerrain.amorti),plateformes=generatePlateformes(cfgTerrain.nbPlateformes),generateSky(c.width,c.height,1800);var a=extremePoints(terrain);vaisseau.init(a.highest.x-300,a.highest.y+200,!0),camera.bottom=a.lowest.y-50,camera.init(vaisseau.posX,vaisseau.posY),renderGame(c),renderInfos(d),compteurCompetences=0;var b=document.querySelectorAll("#barreCompetences div");[].forEach.call(b,function(a){a.className+=" hidden",a.style.opacity=0}),showMessage("Appuyez sur espace pour jouer. <br/><br/>Pour accéder directement à mon CV, il suffit d'entrer le code mystère. (Ou vous pouvez aussi appuyer sur le bouton à côté de mon nom.)")},g=function(){"playing"!=state&&(state="playing",compteurFrames=0,timeStart=Date.now(),e(),hideMessage())};c.height=window.innerHeight-238,d.height=82,d.width=document.body.clientWidth,c.width=document.body.clientWidth,f()});var mod=function(a,b){return(a%b+b)%b},extremePoints=function(a){if(0===a.length)return-1;for(var b=a[0],c=a[0],d=0,e=0,f=1;f<a.length;f++)a[f]>b?(d=f,b=a[f]):a[f]<c&&(e=f,c=a[f]);return{highest:{x:d,y:b},lowest:{x:e,y:c}}},formatTime=function(a){if(isNaN(a))return"0:00";var b=Math.floor(a/1e3),c=Math.floor(b/60);return b%=60,b<10&&(b="0"+b),c+":"+b};!function(){for(var a=0,b=["webkit","moz"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var d=(new Date).getTime(),e=Math.max(0,16-(d-a)),f=window.setTimeout(function(){b(d+e)},e);return a=d+e,f}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}();var camera={offsetX:0,offsetY:0,marginX:150,marginY:100,isZoomed:!1,facteurZoom:1,bottom:0,init:function(a,b){this.offsetX=a-this.marginX,this.offsetY=b+this.marginY-canvas.height},update:function(){vaisseau.posY<terrain[mod(Math.floor(vaisseau.posX),cfgTerrain.width)]+100&&!this.isZoomed?(this.isZoomed=!0,this.facteurZoom=2,this.offsetX=vaisseau.posX-(vaisseau.posX-this.offsetX)/this.facteurZoom,this.offsetY=vaisseau.posY-(vaisseau.posY-this.offsetY)/this.facteurZoom):vaisseau.posY>terrain[mod(Math.floor(vaisseau.posX),cfgTerrain.width)]+150&&this.isZoomed&&(this.isZoomed=!1,this.offsetX=vaisseau.posX-(vaisseau.posX-this.offsetX)*this.facteurZoom,this.offsetY=vaisseau.posY-(vaisseau.posY-this.offsetY)*this.facteurZoom,this.facteurZoom=1),((vaisseau.posX-this.offsetX)*camera.facteurZoom>canvas.width-this.marginX&&vaisseau.velX>0||(vaisseau.posX-this.offsetX)*camera.facteurZoom<this.marginX&&vaisseau.velX<0)&&(this.offsetX+=vaisseau.velX),this.offsetY=(this.marginY-canvas.height)/this.facteurZoom+vaisseau.posY,this.offsetY<this.bottom&&(this.offsetY=this.bottom)}};window.addEventListener("resize",function(){canvas.height=window.innerHeight-238,infos.height=82,infos.width=document.body.clientWidth,canvas.width=document.body.clientWidth,renderGame(canvas),renderInfos(infos)},!1);var renderGame=function(a){var b=a.getContext("2d");b.clearRect(0,0,a.width,a.height),b.save(),b.fillStyle="#000",b.fillRect(0,0,a.width,a.height),b.translate((vaisseau.posX-camera.offsetX)*camera.facteurZoom,a.height-(vaisseau.posY-camera.offsetY)*camera.facteurZoom),b.rotate(vaisseau.angle),b.strokeStyle="#fff",b.lineWidth=1/camera.facteurZoom,b.scale(camera.facteurZoom,camera.facteurZoom),b.beginPath(),b.moveTo(2,-4),b.lineTo(4,-2),b.lineTo(4,2),b.lineTo(2,4),b.lineTo(-2,4),b.lineTo(-4,2),b.lineTo(-4,-2),b.lineTo(-2,-4),b.closePath(),b.rect(-5,4,10,1),b.moveTo(-2,4),b.lineTo(-5,8),b.moveTo(-7,8),b.lineTo(-3,8),b.moveTo(2,4),b.lineTo(5,8),b.moveTo(7,8),b.lineTo(3,8),b.moveTo(-1,4),b.lineTo(-2.5,8),b.moveTo(1,4),b.lineTo(2.5,8),b.moveTo(2,7),b.lineTo(-2,7),0!=vaisseau.acc&&(b.lineTo(0,16.5+3*Math.random()),b.closePath()),b.stroke(),b.restore(),b.fillStyle="#fff";for(var c in stars)stars[c].y>(terrain[mod(stars[c].x+Math.floor(camera.offsetX),cfgTerrain.width)]-Math.floor(camera.offsetY))*camera.facteurZoom&&b.fillRect(stars[c].x*camera.facteurZoom,a.height-stars[c].y,stars[c].size,stars[c].size);b.strokeStyle="#fff",b.lineWidth=1,b.moveTo(0,a.height-(terrain[mod(Math.floor(camera.offsetX),cfgTerrain.width)]-Math.floor(camera.offsetY))),b.beginPath();for(var c=0;c<=a.width/camera.facteurZoom;c++)b.lineTo(c*camera.facteurZoom,a.height-(terrain[mod(c+Math.floor(camera.offsetX),cfgTerrain.width)]-Math.floor(camera.offsetY))*camera.facteurZoom);b.stroke(),b.strokeStyle="#fff",b.lineWidth=4;for(var c=0;c<plateformes.length;c++)plateformes[c].isActive?b.strokeStyle="#fff":b.strokeStyle="#888",b.strokeRect(mod(plateformes[c].index+2-camera.offsetX,cfgTerrain.width)*camera.facteurZoom,a.height-(terrain[plateformes[c].index]-camera.offsetY)*camera.facteurZoom+1,26*camera.facteurZoom,camera.facteurZoom)},renderInfos=function(a){var b=a.getContext("2d");b.fillStyle="#000",b.fillRect(0,0,a.width,a.height),b.fillStyle="#fff",b.font="16px Arial",b.fillText("Score : "+score,50,26),b.fillText("Time : "+formatTime(timeElapsed),50,52),b.fillText("Fuel : "+Math.floor(vaisseau.fuel),50,78),b.fillText("Alt : "+Math.floor((vaisseau.posY-8-terrain[Math.floor(mod(vaisseau.posX,cfgTerrain.width))])/4),a.width-250,26),b.fillText("Horizontal speed : ",a.width-250,52),b.fillText("Vertical speed : ",a.width-250,78),Math.abs(vaisseau.velX)>vaisseau.vlimX&&(b.fillStyle="red"),b.fillText(Math.round(5*vaisseau.velX),a.width-115,52),vaisseau.velY<-vaisseau.vlimY?b.fillStyle="red":b.fillStyle="#fff",b.fillText(Math.round(5*vaisseau.velY),a.width-135,78)},stars=[],generateSky=function(a,b,c){stars=[];for(var d=0;d<c;d++){var e=Math.floor(Math.random()*a),f=Math.floor(Math.random()*b),g=2*Math.random();stars.push({x:e,y:f,size:g})}},son=new Audio("audio/thrust.mp3");son.volume=.3,son.loop=!0;var boom=new Audio("audio/boom.mp3");boom.volume=.4,window.addEventListener("load",function(){document.querySelector("#soundButton").addEventListener("click",function(){son.muted?(this.innerHTML='<span class="icon-volume-up"></span>',boom.muted=!1,son.muted=!1):(this.innerHTML='<span class="icon-volume-off"></span>',boom.muted=!0,son.muted=!0)})});var terrain=[],plateformes=[],initializeTerrain=function(){for(var a=0;a<cfgTerrain.width;a++)terrain[a]=0;terrain[0]=terrain[cfgTerrain.width-1]=200},generateTerrain=function(a,b,c,d){if(a+1!=b){var e=Math.floor((a+b)/2);terrain[e]=(terrain[a]+terrain[b])/2+(Math.random()-.3)*c,generateTerrain(a,e,c*d,.75*d),generateTerrain(e,b,c*d,.75*d)}},generatePlateformes=function(a){for(var b=[],c=0;c<a;c++){for(var d,e=!1;!e;){d=Math.floor(Math.random()*(cfgTerrain.width-30)),e=!0;for(var f=0;f<b.length;f++)d>=b[f].index-100&&d<=b[f].index+100&&(e=!1)}b.push({index:d,isActive:!0});for(var g=0;g<30;g++)g+d<cfgTerrain.width&&(terrain[d+g]=terrain[d])}return b},vaisseau={maxFuel:400,fuel:0,posX:0,posY:0,angle:0,velX:0,velY:0,acc:0,crash:!1,pose:!1,currentPlatform:null,vlimX:.8,vlimY:1,lastVelX:0,lastVelY:0,init:function(a,b,c){c&&(this.fuel=this.maxFuel),this.posX=a,this.posY=b,this.angle=0,this.velX=0,this.velY=0,this.acc=0,this.crash=!1,this.pose=!1,this.currentPlatform=null}},isOnPlatform=function(a,b){for(var c=0;c<b.length;c++)if(mod(a.posX,cfgTerrain.width)>=b[c].index+7&&mod(a.posX,cfgTerrain.width)<=b[c].index+23)return b[c];return null},updateVaisseau=function(){vaisseau.fuel=Math.max(vaisseau.fuel-3*vaisseau.acc,0),vaisseau.velX+=vaisseau.acc*Math.sin(vaisseau.angle),vaisseau.velY+=vaisseau.acc*Math.cos(vaisseau.angle)-gravite,vaisseau.posX+=vaisseau.velX,vaisseau.posY+=vaisseau.velY;for(var a=-7;a<7;a++)vaisseau.posY-9<=terrain[mod(Math.floor(vaisseau.posX+a),cfgTerrain.width)]?(vaisseau.currentPlatform=isOnPlatform(vaisseau,plateformes),vaisseau.velY<-vaisseau.vlimY||Math.abs(vaisseau.velX)>vaisseau.vlimX||null==vaisseau.currentPlatform||mod(vaisseau.angle,2*Math.PI)<11*Math.PI/6&&mod(vaisseau.angle,2*Math.PI)>Math.PI/6?vaisseau.crash=!0:vaisseau.crash||vaisseau.pose||(vaisseau.pose=!0,vaisseau.angle=0,vaisseau.posY=terrain[mod(Math.floor(vaisseau.posX+a),cfgTerrain.width)]+9,vaisseau.lastVelX=vaisseau.velX,vaisseau.lastVelY=vaisseau.velY),gravite=0,vaisseau.acc=0,vaisseau.velX=0,vaisseau.velY=0):(vaisseau.pose=!1,gravite=.005)},cheatCode=[38,38,40,40,37,39,37,39,66,65],lastKeys=[0,0,0,0,0,0,0,0,0,0];window.addEventListener("load",function(a){document.querySelector("#cheatButton").addEventListener("click",afficherIcones)});var afficherIcones=function(){document.querySelector("#cheatButton").style.display="none",icones=document.querySelectorAll("nav a"),[].forEach.call(icones,function(a){a.style.display="inline-block"})};})();